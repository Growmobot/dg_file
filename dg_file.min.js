dg.createModule("dg_file"),dg_file._fileWidgets={},dg_file.getFileWidget=function(e){return dg_file._fileWidgets[e]?dg_file._fileWidgets[e]:null},dg_file.setFileWidget=function(e,i){dg_file._fileWidgets[e]=i},dg_file._fileInputs={},dg_file.getFileInput=function(e){return dg_file._fileInputs[e]?dg_file._fileInputs[e]:null},dg_file.setFileInput=function(e,i){dg_file._fileInputs[e]=i},dg.FileElement=function(e,i,d){dg.FormElementPrepare(this,arguments)},dg.FileElement.prototype=new dg.FormElement,dg.FileElement.prototype.constructor=dg.FileElement,dg_file.setMessage=function(e,i){dg.qs("#dg-file-form-messages").innerHTML=dg.render({_theme:"message",_type:i?i:"status",_message:e})},dg_file.clearMessage=function(){dg.qs("#dg-file-form-messages").innerHTML=""},dg_file.parseFid=function(e){return parseInt(e)},dg_file.getFileElementNamesFromForm=function(e){var i=[];if(e.elements)for(var d in e.elements)if(e.elements.hasOwnProperty(d)){var l=e.elements[d];if(l.type&&"file"==l.type){i.push(d);break}}return i.length?i:null},dg_file._pendingFileIds=[],dg_file.getPendingFileIds=function(){return dg_file._pendingFileIds},dg_file.setPendingFileIds=function(e){dg_file._pendingFileIds=e},dg_file.hasPendingFileIds=function(){return dg_file.getPendingFileIds().length},dg_file.isPendingFileId=function(e){return in_array(dg_file.parseFid(e),dg_file.getPendingFileIds())},dg_file.addToPendingFileIds=function(e){e=dg_file.parseFid(e),dg_file.isPendingFileId(e)||(dg_file.getPendingFileIds().push(e),console.log("added to pending list: "+e))},dg_file.removeFromPendingFileIds=function(e){e=dg_file.parseFid(e);var i=dg_file.getPendingFileIds();console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds()),i=i.filter(function(i){return i!==e}),dg_file.setPendingFileIds(i),console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds())},dg_file.read=function(e){},dg.theme_file_input=function(e){var i=e._attributes;i.id||(i.id="dg-file-widget-"+dg.salt());var d=i.id;dg_file.setFileInput(d,e);var l=d+"-wrapper",n='<div id="'+l+'" class="dg-file-widget-wrapper">';if(e._file){e._file}else{var t=d+"-preview";i.type||(i.type="file"),i.onchange||(i.onchange="dg_file.chooseFileOnchange('"+l+"', '"+i.id+"', '"+t+"', '"+e._formInputId+"')"),i.class.push("dg-file-widget");var g="<input "+dg.attrs(e)+"/>",s={id:t,src:"",class:["dg-file-preview"]},f="<img "+dg.attributes(s)+">";n+=g+f}return n+"</div>"},dg_file.chooseFileOnchange=function(e,i,d,l){var n=dg_file.getFileWidget(l),t=(dg_file.getFileInput(i),dg.qs("#"+i)),g=t.files[0];if(g){var s=dg.qs("#"+d),f=new FileReader;f.addEventListener("load",function(){s.src=f.result,s.height=64;var e=f.result;0===e.indexOf("data:image")&&(e=e.substring(e.indexOf(",")+1));var i=g.name,d="public://",r=n._filePathDir;r&&(d+=r+"/"),d+=i;var a={file:e,filename:i,filepath:d};dg.hide(t),dg_file.setMessage(dg.t("Uploading file, please wait...")),file_save(a,{success:function(e){if(console.log("file_save",e),e.fid){var i=e.fid;dg.qs("#"+l).value=i,dg_file.clearMessage();var d="dg-file-preview-"+dg.salt(),n=dg.qs('.dg-file-wrapper[data-id="'+l+'"]');n.innerHTML='<img id="'+d+'" class="dg-file-preview" />',setTimeout(function(){var e=dg.qs("#"+d);e.src=f.result,e.height=96},1)}else dg.error(null,null,dg.t("There was a problem saving the file."))},error:function(e,i,d){dg_file.setMessage(d,"error")}})},!1),g&&f.readAsDataURL(g)}},dg_file.widgetRemoveOnclick=function(e){var i=e.getAttribute("data-fid"),d=function(e,i,d){dg.alert(d)};file_delete(i,{success:function(e){console.log(e),e[0]||d(null,null,dg.t("There was a problem removing the file."))},error:d})},dg.theme_file=function(e){var i=e._attributes;i.id||(i.id="file-"+dg.salt());var d=i.id;return dg_file.setFileWidget(d,e),i.type="hidden","<input "+dg.attrs(e)+" />"+dg.render({_prefix:'<div id="dg-file-form-messages"></div>',_theme:"file_input",_formInputId:d})};