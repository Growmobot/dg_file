dg.createModule("dg_file"),dg.FileElement=function(e,i,n){dg.FormElementPrepare(this,arguments)},dg.FileElement.prototype=new dg.FormElement,dg.FileElement.prototype.constructor=dg.FileElement,DgFile=function(){},dg_file.setMessage=function(e,i){document.getElementById("dg-file-form-messages").innerHTML=dg.render({_theme:"message",_type:i?i:"status",_message:e})},dg_file.parseFid=function(e){return parseInt(e)},dg_file.getFileElementNamesFromForm=function(e){var i=[];if(e.elements)for(var n in e.elements)if(e.elements.hasOwnProperty(n)){var l=e.elements[n];if(l.type&&"file"==l.type){i.push(n);break}}return i.length?i:null},dg_file._pendingFileIds=[],dg_file.getPendingFileIds=function(){return dg_file._pendingFileIds},dg_file.setPendingFileIds=function(e){dg_file._pendingFileIds=e},dg_file.hasPendingFileIds=function(){return dg_file.getPendingFileIds().length},dg_file.isPendingFileId=function(e){return in_array(dg_file.parseFid(e),dg_file.getPendingFileIds())},dg_file.addToPendingFileIds=function(e){e=dg_file.parseFid(e),dg_file.isPendingFileId(e)||(dg_file.getPendingFileIds().push(e),console.log("added to pending list: "+e))},dg_file.removeFromPendingFileIds=function(e){e=dg_file.parseFid(e);var i=dg_file.getPendingFileIds();console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds()),i=i.filter(function(i){return i!==e}),dg_file.setPendingFileIds(i),console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds())},dg_file.read=function(e){},dg.createForm("FileForm",function(){this.buildForm=function(e,i,n){return new Promise(function(i,l){console.log("buildForm - variables",n),e.file={_prefix:'<div id="dg-file-form-messages"></div>',_type:"file_input",_formInputId:n._formInputId},i(e)})}}),dg.theme_file_input=function(e){console.log("theme_file_input",e);var i=e._attributes;i.id||(i.id="dg-file-widget-"+jDrupal.userPassword());var n=i.id+"-wrapper",l='<div id="'+n+'" class="dg-file-widget-wrapper">';if(e._file){var t=e._file;console.log("existing file",t)}else{var d=i.id+"-preview";i.type||(i.type="file"),i.onchange||(i.onchange="dg_file.chooseFileOnchange('"+n+"', '"+i.id+"', '"+d+"', '"+e._formInputId+"')"),i.class.push("dg-file-widget");var g="<input "+dg.attrs(e)+"/>",r={id:d,src:"",class:["dg-file-preview"]},s="<img "+dg.attributes(r)+">";l+=g+s}return l+"</div>"},dg_file.chooseFileOnchange=function(e,i,n,l){console.log("chooseFileOnchange",arguments);var t=dg.qs("#"+i);console.log("input",t);var d=t.files[0];if(d){console.log("file input",d);var g=dg.qs("#"+n),r=new FileReader;r.addEventListener("load",function(){g.src=r.result,g.height=64;var e={file:r.result,filename:d.name,filepath:"public://"+d.name};dg.hide(t),dg_file.setMessage(dg.t("Uploading file, please wait...")),file_save(e,{success:function(e){if(console.log("file_save",e),e.fid){var i=e.fid;dg.qs("#"+l).value=i,dg_file.setMessage(dg.t("File uploaded!"))}else dg.error(null,null,dg.t("There was a problem saving the file."))},error:function(e,i,n){dg_file.setMessage(n,"error")}})},!1),d&&r.readAsDataURL(d)}},dg_file.showFileInput=function(e){dg_file.getFileInput()},dg_file.widgetRemoveOnclick=function(e){file_delete(e,{success:function(e){console.log(e)},error:dg.error})},dg.theme_file=function(e){var i=e._attributes;return i.id||(i.id="file-"+jDrupal.userPassword()),i.type="hidden","<input "+dg.attrs(e)+' /><div class="dg-file-wrapper">'+dg.b(dg.t("Attach file"),{_attributes:{onclick:"dg_file.attachFileOnclick(this)",title:e._title?e._title:dg.t("File"),"data-form-input-id":i.id}})+"</div>"},dg_file.attachFileOnclick=function(e){var i={};return i.controls={_theme:"form",_id:"FileForm",_formInputId:e.getAttribute("data-form-input-id")},dg.modal(i,{title:e.getAttribute("title")}),!1};