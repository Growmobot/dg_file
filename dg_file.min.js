dg.createModule("dg_file"),dg.FileElement=function(e,i,d){dg.FormElementPrepare(this,arguments)},dg.FileElement.prototype=new dg.FormElement,dg.FileElement.prototype.constructor=dg.FileElement,DgFile=function(){},dg_file.setMessage=function(e,i){document.getElementById("dg-file-form-messages").innerHTML=dg.render({_theme:"message",_type:i?i:"status",_message:e})},dg_file.parseFid=function(e){return parseInt(e)},dg_file.getFileElementNamesFromForm=function(e){var i=[];if(e.elements)for(var d in e.elements)if(e.elements.hasOwnProperty(d)){var t=e.elements[d];if(t.type&&"file"==t.type){i.push(d);break}}return i.length?i:null},dg_file._pendingFileIds=[],dg_file.getPendingFileIds=function(){return dg_file._pendingFileIds},dg_file.setPendingFileIds=function(e){dg_file._pendingFileIds=e},dg_file.hasPendingFileIds=function(){return dg_file.getPendingFileIds().length},dg_file.isPendingFileId=function(e){return in_array(dg_file.parseFid(e),dg_file.getPendingFileIds())},dg_file.addToPendingFileIds=function(e){e=dg_file.parseFid(e),dg_file.isPendingFileId(e)||(dg_file.getPendingFileIds().push(e),console.log("added to pending list: "+e))},dg_file.removeFromPendingFileIds=function(e){e=dg_file.parseFid(e);var i=dg_file.getPendingFileIds();console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds()),i=i.filter(function(i){return i!==e}),dg_file.setPendingFileIds(i),console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds())},dg_file.read=function(e){},dg.createForm("FileForm",function(){this.buildForm=function(e,i,d){return new Promise(function(i,t){e.file={_prefix:'<div id="dg-file-form-messages"></div>',_type:"file_input",_formInputId:d._formInputId},i(e)})}}),dg.theme_file_input=function(e){var i=e._attributes;i.id||(i.id="dg-file-widget-"+dg.salt());var d=i.id+"-wrapper",t='<div id="'+d+'" class="dg-file-widget-wrapper">';if(e._file){e._file}else{var n=i.id+"-preview";i.type||(i.type="file"),i.onchange||(i.onchange="dg_file.chooseFileOnchange('"+d+"', '"+i.id+"', '"+n+"', '"+e._formInputId+"')"),i.class.push("dg-file-widget");var l="<input "+dg.attrs(e)+"/>",g={id:n,src:"",class:["dg-file-preview"]},r="<img "+dg.attributes(g)+">";t+=l+r}return t+"</div>"},dg_file.chooseFileOnchange=function(e,i,d,t){var n=dg.qs("#"+i),l=n.files[0];if(l){var g=dg.qs("#"+d),r=new FileReader;r.addEventListener("load",function(){g.src=r.result,g.height=64;var e=r.result;0===e.indexOf("data:image")&&(e=e.substring(e.indexOf(",")+1));var i={file:e,filename:l.name,filepath:"public://"+l.name};dg.hide(n),dg_file.setMessage(dg.t("Uploading file, please wait...")),file_save(i,{success:function(e){if(e.fid){var i=e.fid;dg.qs("#"+t).value=i,dg_file.setMessage(dg.t("File uploaded!"))}else dg.error(null,null,dg.t("There was a problem saving the file."))},error:function(e,i,d){dg_file.setMessage(d,"error")}})},!1),l&&r.readAsDataURL(l)}},dg_file.showFileInput=function(e){dg_file.getFileInput()},dg_file.widgetRemoveOnclick=function(e){file_delete(e,{success:function(e){console.log(e)},error:dg.error})},dg.theme_file=function(e){var i=e._attributes;return i.id||(i.id="file-"+jDrupal.userPassword()),i.type="hidden","<input "+dg.attrs(e)+' /><div class="dg-file-wrapper">'+dg.b(dg.t("Attach file"),{_attributes:{onclick:"dg_file.attachFileOnclick(this)",title:e._title?e._title:dg.t("File"),"data-form-input-id":i.id}})+"</div>"},dg_file.attachFileOnclick=function(e){var i={};return i.controls={_theme:"form",_id:"FileForm",_formInputId:e.getAttribute("data-form-input-id")},dg.modal(i,{title:e.getAttribute("title")}),!1};