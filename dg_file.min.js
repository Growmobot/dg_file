dg.createModule("dg_file"),dg_file._fileWidgets={},dg_file.getFileWidget=function(e){return dg_file._fileWidgets[e]?dg_file._fileWidgets[e]:null},dg_file.setFileWidget=function(e,i){dg_file._fileWidgets[e]=i},dg_file._fileInputs={},dg_file.getFileInput=function(e){return dg_file._fileInputs[e]?dg_file._fileInputs[e]:null},dg_file.setFileInput=function(e){dg_file._fileInputs[e.id()]=e},dg.FileElement=function(e,i,t){dg.FormElementPrepare(this,arguments)},dg.FileElement.prototype=new dg.FormElement,dg.FileElement.prototype.constructor=dg.FileElement,DgFileInput=function(e){this._variables=e;var i=this._variables._attributes;i.id||(i.id="dg-file-widget-"+dg.salt());var t=i.id;this._id=t,this._wrapperId=t+"-wrapper",this._previewId=t+"-preview",this._formInputId=e._formInputId},DgFileInput.prototype.id=function(){return this._id},DgFileInput.prototype.getVars=function(){return this._variables},DgFileInput.prototype.getAttributes=function(){return this.getVars()._attributes},DgFileInput.prototype.getWrapperId=function(){return this._wrapperId},DgFileInput.prototype.getPreviewId=function(){return this._previewId},DgFileInput.prototype.getFormInputId=function(){return this._formInputId},DgFileInput.prototype.getInput=function(){return dg.qs("#"+this.id())},DgFileInput.prototype.html=function(){console.log("HTML!");var e=this.getWrapperId(),i='<div id="'+e+'" class="dg-file-widget-wrapper">',t=this.getPreviewId(),n=(this.getFormInputId(),null),l=this.getAttributes();dg.isCompiled()?(l.onclick="dg_file.openFilePicker(this, '"+this.id()+"')",n=dg.b(dg.t("Choose File"),{_attributes:l})):(l.type||(l.type="file"),l.onchange||(l.onchange="dg_file.chooseFileOnchange('"+this.id()+"')"),l.class.push("dg-file-widget"),n="<input "+dg.attributes(l)+"/>");var d={id:t,src:"",class:["dg-file-preview"]},g="<img "+dg.attributes(d)+">";return i+=n+g,i+"</div>"},DgFileInput.prototype.hideInput=function(){dg.hide(this.getInput())},DgFileInput.prototype.setPreview=function(e){var i=dg.qs("#"+this.getPreviewId());i.src=e,i.height=64},DgFileInput.prototype.getMessageBox=function(){return dg.qs("#dg-file-form-messages")},DgFileInput.prototype.setMessage=function(e,i){this.getMessageBox().innerHTML=dg.render({_theme:"message",_type:i?i:"status",_message:e})},DgFileInput.prototype.clearMessage=function(e,i){this.getMessageBox().innerHTML=""},dg_file.setOptions=function(e){return{quality:100,destinationType:Camera.DestinationType.FILE_URI,sourceType:e,encodingType:Camera.EncodingType.JPEG,mediaType:Camera.MediaType.PICTURE,allowEdit:!0,correctOrientation:!0}},dg_file.encodeImageUri=function(e){return new Promise(function(i,t){console.log("encoding ",e);var n=document.createElement("canvas"),l=n.getContext("2d"),d=new Image;d.onload=function(){n.width=this.width,n.height=this.height,l.drawImage(d,0,0),console.log("resolving"),i(n.toDataURL("image/jpeg"))},d.src=e})},dg_file.loaded=function(e,i,t){console.log("loaded()",e);var n=dg.isCompiled(),l=dg_file.getFileInput(t),d=l.getFormInputId(),g=dg_file.getFileWidget(d);console.log("widgetVariables",g);var o=function(t){console.log("trimming for drupal"),0===t.indexOf("data:image")&&(t=t.substring(t.indexOf(",")+1)),console.log("done trimming for drupal");var n=e.name,o="public://",r=g._filePathDir;r&&(o+=r+"/"),o+=n;var s={file:t,filename:n,filepath:o};console.log("fileData",s.filename,s.filepath),l.hideInput(),l.setMessage(dg.t("Uploading")+"..."),file_save(s,{success:function(e){console.log("file_save",e),e.fid?(dg.qs("#"+d).value=e.fid,l.clearMessage(),l.setPreview(i)):dg.error(null,null,dg.t("There was a problem saving the file."))},error:function(e,i,t){l.setMessage(t,"error")}})};n?dg_file.encodeImageUri(i).then(function(e){o(e)}):o(i)},dg_file.parseFid=function(e){return parseInt(e)},dg_file.getFileElementNamesFromForm=function(e){var i=[];if(e.elements)for(var t in e.elements)if(e.elements.hasOwnProperty(t)){var n=e.elements[t];if(n.type&&"file"==n.type){i.push(t);break}}return i.length?i:null},dg_file._pendingFileIds=[],dg_file.getPendingFileIds=function(){return dg_file._pendingFileIds},dg_file.setPendingFileIds=function(e){dg_file._pendingFileIds=e},dg_file.hasPendingFileIds=function(){return dg_file.getPendingFileIds().length},dg_file.isPendingFileId=function(e){return in_array(dg_file.parseFid(e),dg_file.getPendingFileIds())},dg_file.addToPendingFileIds=function(e){e=dg_file.parseFid(e),dg_file.isPendingFileId(e)||(dg_file.getPendingFileIds().push(e),console.log("added to pending list: "+e))},dg_file.removeFromPendingFileIds=function(e){e=dg_file.parseFid(e);var i=dg_file.getPendingFileIds();console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds()),i=i.filter(function(i){return i!==e}),dg_file.setPendingFileIds(i),console.log("removeFromPendingFileIds",e,dg_file.getPendingFileIds())},dg_file.read=function(e){},dg.theme_file_input=function(e){var i=new DgFileInput(e);return dg_file.setFileInput(i),i.html()},dg_file.chooseFileOnchange=function(e){console.log("chooseFileOnchange",arguments);var i=dg_file.getFileInput(e);console.log("fileInput",i);var t=i.getInput();console.log("input",t);var n=t.files[0];if(n){console.log("file input",n);var l=new FileReader;l.addEventListener("load",function(){dg_file.loaded(n,l.result,e)},!1),n&&l.readAsDataURL(n)}},dg_file.openFilePicker=function(e,i,t){console.log("openFilePicker",arguments);var n=Camera.PictureSourceType.SAVEDPHOTOALBUM,l=dg_file.setOptions(n);navigator.camera.getPicture(function(n){window.resolveLocalFileSystemURI(n,function(l){console.log(l.fullPath),console.log(l),l.file(function(l){dg_file.loaded(l,n,e.getAttribute("id"),i,t)})},function(){})},function(e){console.debug("Unable to obtain picture: "+e,"app")},l)},dg_file.widgetRemoveOnclick=function(e){var i=e.getAttribute("data-fid"),t=function(e,i,t){dg.alert(t)};file_delete(i,{success:function(e){console.log(e),e[0]||t(null,null,dg.t("There was a problem removing the file."))},error:t})},dg.theme_file=function(e){console.log("theme_file",e);var i=e._attributes;i.id||(i.id="file-"+dg.salt());var t=i.id;return dg_file.setFileWidget(t,e),i.type="hidden","<input "+dg.attrs(e)+" />"+dg.render({_prefix:'<div id="dg-file-form-messages"></div>',_theme:"file_input",_formInputId:t})};